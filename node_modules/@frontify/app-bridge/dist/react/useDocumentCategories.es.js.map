{"version":3,"file":"useDocumentCategories.es.js","sources":["../../src/react/useDocumentCategories.ts"],"sourcesContent":["/* (c) Copyright Frontify Ltd., all rights reserved. */\n\nimport { useCallback, useEffect, useState } from 'react';\nimport { produce } from 'immer';\n\nimport type { AppBridgeBlock } from '../AppBridgeBlock';\nimport type { AppBridgeTheme } from '../AppBridgeTheme';\nimport type { DocumentCategory, EmitterEvents } from '../types';\n\ntype DocumentPageEvent = EmitterEvents['AppBridge:GuidelineDocumentCategory:DocumentPageAction'];\ntype DocumentCategoryMoveEvent = EmitterEvents['AppBridge:GuidelineDocumentCategory:MoveEvent'];\n\ntype Options = {\n    /**\n     * Whether it should fetch on mount.\n     */\n    enabled?: boolean;\n};\n\nconst sortDocumentCategories = (a: DocumentCategory, b: DocumentCategory) => (a.sort && b.sort ? a.sort - b.sort : 0);\n\nexport const useDocumentCategories = (\n    appBridge: AppBridgeBlock | AppBridgeTheme,\n    documentId: number,\n    options: Options = { enabled: true },\n) => {\n    const [documentCategories, setDocumentCategories] = useState<Map<number, DocumentCategory>>(new Map([]));\n    const [isLoading, setIsLoading] = useState<boolean>(true);\n\n    const refetch = useCallback(async () => {\n        setIsLoading(true);\n        setDocumentCategories(await fetchDocumentCategories(appBridge, documentId));\n        setIsLoading(false);\n    }, [appBridge, documentId]);\n\n    useEffect(() => {\n        if (options.enabled) {\n            refetch();\n        }\n    }, [refetch, options.enabled]);\n\n    useEffect(() => {\n        const handleDocumentPageEvent = (\n            event: EmitterEvents['AppBridge:GuidelineDocumentCategory:DocumentPageAction'],\n        ) => {\n            if (!documentCategories.has(event.documentPage.categoryId)) {\n                return;\n            }\n\n            setDocumentCategories(\n                produce((draft) => {\n                    const action = `${event.action}-page` as const;\n                    const handler = actionHandlers[action] || actionHandlers.default;\n                    return handler(draft, event.documentPage);\n                }),\n            );\n        };\n\n        const handleDocumentCategoryMoveEvent = (event: DocumentCategoryMoveEvent) => {\n            if (!documentCategories.has(event.documentCategory.id)) {\n                return;\n            }\n\n            setDocumentCategories(\n                produce((draft) => {\n                    previewDocumentCategorySort(draft, event.documentCategory, event.position);\n                }),\n            );\n        };\n\n        const handler = ({ action, documentCategory }: EmitterEvents['AppBridge:GuidelineDocumentCategory:Action']) => {\n            if (\n                (action === 'update' && documentCategories.has(documentCategory.id)) ||\n                (action === 'add' && documentCategory.documentId === documentId)\n            ) {\n                refetch();\n            } else if (action === 'delete' && documentCategories.has(documentCategory.id)) {\n                setDocumentCategories(\n                    produce((draft) => {\n                        draft.delete(documentCategory.id);\n                    }),\n                );\n            }\n        };\n\n        window.emitter.on('AppBridge:GuidelineDocumentCategory:Action', handler);\n        window.emitter.on('AppBridge:GuidelineDocumentCategory:DocumentPageAction', handleDocumentPageEvent);\n        window.emitter.on('AppBridge:GuidelineDocumentCategory:MoveEvent', handleDocumentCategoryMoveEvent);\n\n        return () => {\n            window.emitter.off('AppBridge:GuidelineDocumentCategory:Action', handler);\n            window.emitter.off('AppBridge:GuidelineDocumentCategory:DocumentPageAction', handleDocumentPageEvent);\n            window.emitter.off('AppBridge:GuidelineDocumentCategory:MoveEvent', handleDocumentCategoryMoveEvent);\n        };\n    }, [documentCategories, documentId, refetch]);\n\n    return { documentCategories: Array.from(documentCategories.values()), refetch, isLoading };\n};\n\nconst previewDocumentCategorySort = (\n    documentCategories: Map<number, DocumentCategory>,\n    documentCategory: DocumentCategoryMoveEvent['documentCategory'],\n    newPosition: DocumentCategoryMoveEvent['position'],\n) => {\n    if (!documentCategory.sort || !newPosition) {\n        return documentCategories;\n    }\n\n    const previousCategory = documentCategories.get(documentCategory.id);\n    const documentCategoriesAsArray: DocumentCategory[] = [...documentCategories.values()].sort(sortDocumentCategories);\n\n    documentCategories.clear();\n\n    let sort = 1;\n    let isOnLastPosition = true;\n    for (const currentDocumentCategory of documentCategoriesAsArray) {\n        if (currentDocumentCategory.id === documentCategory.id) {\n            continue;\n        }\n\n        if (previousCategory && sort === newPosition) {\n            documentCategories.set(documentCategory.id, { ...previousCategory, sort: newPosition });\n            isOnLastPosition = false;\n        }\n\n        documentCategories.set(currentDocumentCategory.id, {\n            ...currentDocumentCategory,\n            sort,\n        });\n\n        sort++;\n    }\n\n    if (previousCategory && isOnLastPosition) {\n        documentCategories.set(documentCategory.id, { ...previousCategory, sort });\n    }\n\n    return documentCategories;\n};\n\nconst addDocumentPage = (\n    documentCategories: Map<number, DocumentCategory>,\n    documentPageToAdd: DocumentPageEvent['documentPage'],\n) => {\n    if (!documentPageToAdd.categoryId) {\n        return documentCategories;\n    }\n\n    const documentCategory = documentCategories.get(documentPageToAdd.categoryId);\n    if (!documentCategory) {\n        return documentCategories;\n    }\n\n    const newDocumentCategory = {\n        ...documentCategory,\n        numberOfDocumentPages: documentCategory.numberOfDocumentPages + 1,\n    };\n\n    return documentCategories.set(documentCategory.id, newDocumentCategory);\n};\n\nconst deleteDocumentPage = (\n    documentCategories: Map<number, DocumentCategory>,\n    documentPageToDelete: DocumentPageEvent['documentPage'],\n) => {\n    if (!documentPageToDelete.categoryId) {\n        return documentCategories;\n    }\n\n    const documentCategory = documentCategories.get(documentPageToDelete.categoryId);\n    if (!documentCategory) {\n        return documentCategories;\n    }\n\n    const newDocumentCategory = {\n        ...documentCategory,\n        numberOfDocumentPages: documentCategory.numberOfDocumentPages - 1,\n    };\n\n    return documentCategories.set(documentCategory.id, newDocumentCategory);\n};\n\nconst actionHandlers = {\n    'add-page': addDocumentPage,\n    'delete-page': deleteDocumentPage,\n    default: (documentCategories: Map<number, DocumentCategory>) => documentCategories,\n};\n\nconst fetchDocumentCategories = async (appBridge: AppBridgeBlock | AppBridgeTheme, documentId: number) => {\n    const categories = await appBridge.getDocumentCategoriesByDocumentId(documentId);\n    return new Map([...categories].sort(sortDocumentCategories).map((category) => [category.id, category]));\n};\n"],"names":["sortDocumentCategories","a","b","useDocumentCategories","appBridge","documentId","options","documentCategories","setDocumentCategories","useState","isLoading","setIsLoading","refetch","useCallback","fetchDocumentCategories","useEffect","handleDocumentPageEvent","event","produce","draft","action","handler","actionHandlers","handleDocumentCategoryMoveEvent","previewDocumentCategorySort","documentCategory","newPosition","previousCategory","documentCategoriesAsArray","sort","isOnLastPosition","currentDocumentCategory","addDocumentPage","documentPageToAdd","newDocumentCategory","deleteDocumentPage","documentPageToDelete","categories","category"],"mappings":"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"}